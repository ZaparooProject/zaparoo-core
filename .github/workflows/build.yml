name: Build all releases
on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag/version to build (e.g. v2.7.0). Leave empty for commit-based version.'
        required: false
        type: string
        default: ''
      test_build:
        description: 'Test build only (no release created, uses test-signing)'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      tag:
        description: 'Tag to build (e.g. v2.7.0)'
        required: true
        type: string
      is_nightly:
        description: 'Is this a nightly build?'
        required: false
        type: boolean
        default: false
      test_build:
        description: 'Test build only (no release created)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

concurrency:
  group: release-${{ inputs.tag || github.ref_name }}
  cancel-in-progress: false  # Never cancel releases

env:
  BUILD_TAG: ${{ inputs.tag || github.ref_name }}

jobs:
  # Ensure zigcc Docker image is available (builds if needed, skips if exists)
  ensure-zigcc:
    uses: ./.github/workflows/zigcc-build.yml
    permissions:
      contents: read
      packages: write

  create-release:
    if: ${{ !inputs.test_build }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Create release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ env.BUILD_TAG }}
          is_nightly: ${{ inputs.is_nightly || 'false' }}
        run: |
          # Detect nightly builds and mark as pre-release
          if [[ "$is_nightly" == "true" ]] || [[ "$tag" == *"nightly"* ]]; then
            PRERELEASE="--prerelease"
            TITLE="Nightly Build ${tag}"
          else
            PRERELEASE=""
            TITLE="${tag}"
          fi

          gh release create "$tag" \
              --repo="$GITHUB_REPOSITORY" \
              --title="${TITLE}" \
              --draft \
              ${PRERELEASE} \
              --generate-notes

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [create-release, ensure-zigcc]
    if: ${{ !cancelled() && needs.ensure-zigcc.result == 'success' }}
    permissions:
      contents: write  # Needed for uploading release assets
      packages: read   # Needed for pulling Docker images from ghcr.io
      actions: read    # Needed for SignPath to read artifacts
    strategy:
      fail-fast: false
      matrix:
        platform:
          - windows
          - mac
          - batocera
          - bazzite
          - chimeraos
          - linux
          - libreelec
        arch:
          - amd64
          - arm64
        include:
          - platform: steamos
            arch: amd64
          - platform: mister
            arch: arm
          - platform: mistex
            arch: arm64
          - platform: batocera
            arch: arm
          - platform: windows
            arch: 386
          - platform: libreelec
            arch: arm
    steps:
      - uses: actions/checkout@v4
      - id: zaparooapprel
        uses: pozetroninc/github-action-get-latest-release@v0.8.0
        with:
          repository: ZaparooProject/zaparoo-app
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Get latest Zaparoo App web build
        run: |
          APP_TAG="${{ steps.zaparooapprel.outputs.release }}"
          APP_VERSION="${APP_TAG#v}"
          APP_FILENAME="zaparoo_app-web-core-${APP_VERSION}.tar.gz"
          curl -fsSL -o "pkg/assets/_app/${APP_FILENAME}" "https://github.com/ZaparooProject/zaparoo-app/releases/download/${APP_TAG}/${APP_FILENAME}"
          mkdir pkg/assets/_app/dist
          tar xf "pkg/assets/_app/${APP_FILENAME}" -C pkg/assets/_app/dist/
      - name: Write release version
        run: |
          VERSION="${BUILD_TAG#v}"
          # For test builds without a real version tag, use commit hash
          if [[ ! "$VERSION" =~ ^[0-9] ]]; then
            VERSION="$(git rev-parse --short HEAD)-dev"
          fi
          echo "Version: $VERSION"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true
      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Docker CLI
        uses: docker/setup-buildx-action@v3
        with:
          use: true
          install: true
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set lowercase repository owner
        run: |
          echo "OWNER_LC=${OWNER,,}" >> "$GITHUB_ENV"
        env:
          OWNER: ${{ github.repository_owner }}
      - name: Pull zigcc image
        run: |
          ZIGCC_VERSION="${{ needs.ensure-zigcc.outputs.version }}"
          echo "Using zigcc version: $ZIGCC_VERSION"
          docker pull ghcr.io/${{ env.OWNER_LC }}/zigcc:${ZIGCC_VERSION}
          docker tag ghcr.io/${{ env.OWNER_LC }}/zigcc:${ZIGCC_VERSION} zaparoo/zigcc
      - name: Build
        env:
          GOFLAGS: "-buildvcs=false"
        run: APP_VERSION=${VERSION} task ${{matrix.platform}}:build-${{matrix.arch}}
      - name: Upload unsigned exe artifact
        if: matrix.platform == 'windows'
        id: upload-unsigned-exe
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-exe-${{matrix.arch}}
          path: _build/${{matrix.platform}}_${{matrix.arch}}/Zaparoo.exe
          retention-days: 30
      - name: Upload unsigned installer artifact
        if: matrix.platform == 'windows'
        id: upload-unsigned-installer
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-installer-${{matrix.arch}}
          path: _build/windows_${{matrix.arch}}/Output/zaparoo-${{matrix.arch}}-${VERSION}-setup.exe
          retention-days: 30
      - name: Copy installer to consistent name for signing
        if: matrix.platform == 'windows'
        run: |
          cp "_build/windows_${{matrix.arch}}/Output/zaparoo-${{matrix.arch}}-${VERSION}-setup.exe" \
             "_build/windows_${{matrix.arch}}/Output/zaparoo-setup.exe"
      - name: Sign exe file
        if: matrix.platform == 'windows'
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: '${{ secrets.SIGNPATH_API_TOKEN }}'
          organization-id: '${{ secrets.SIGNPATH_ORGANIZATION_ID }}'
          project-slug: 'zaparoo-core'
          signing-policy-slug: 'release-signing'
          artifact-configuration-slug: 'windows-zip'
          github-artifact-id: '${{ steps.upload-unsigned-exe.outputs.artifact-id }}'
          wait-for-completion: true
          output-artifact-directory: '_build/signed/exe_${{matrix.arch}}'
      - name: Sign installer EXE
        if: matrix.platform == 'windows'
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: '${{ secrets.SIGNPATH_API_TOKEN }}'
          organization-id: '${{ secrets.SIGNPATH_ORGANIZATION_ID }}'
          project-slug: 'zaparoo-core'
          signing-policy-slug: 'release-signing'
          artifact-configuration-slug: 'windows-installer'
          github-artifact-id: '${{ steps.upload-unsigned-installer.outputs.artifact-id }}'
          wait-for-completion: true
          output-artifact-directory: '_build/signed/installer_${{matrix.arch}}'
      - name: Rename signed installer back to versioned name
        if: matrix.platform == 'windows'
        run: |
          mv "_build/signed/installer_${{matrix.arch}}/zaparoo-setup.exe" \
             "_build/signed/installer_${{matrix.arch}}/zaparoo-${{matrix.arch}}-${VERSION}-setup.exe"
      - name: Repackage distribution ZIP with signed exe
        if: matrix.platform == 'windows'
        run: |
          # Replace unsigned exe with signed exe in build directory
          cp "_build/signed/exe_${{matrix.arch}}/Zaparoo.exe" "_build/${{matrix.platform}}_${{matrix.arch}}/Zaparoo.exe"
          # Recreate the distribution ZIP
          APP_VERSION=${VERSION} go run scripts/tasks/utils/makezip/main.go \
            ${{matrix.platform}} "_build/${{matrix.platform}}_${{matrix.arch}}" Zaparoo.exe \
            "zaparoo-${{matrix.platform}}_${{matrix.arch}}-${VERSION}.zip"
      - name: Add signed ZIP to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ env.BUILD_TAG }}
        if: matrix.platform == 'windows' && !inputs.test_build
        run: |
          gh release upload "$tag" "_build/${{matrix.platform}}_${{matrix.arch}}/zaparoo-${{matrix.platform}}_${{matrix.arch}}-${VERSION}.zip" --clobber
      - name: Add signed Windows installer to release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ env.BUILD_TAG }}
        if: matrix.platform == 'windows' && !inputs.test_build
        run: |
          gh release upload "$tag" "_build/signed/installer_${{matrix.arch}}/zaparoo-${{matrix.arch}}-${VERSION}-setup.exe" --clobber
      - name: Add release (non-Windows)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ env.BUILD_TAG }}
        if: matrix.platform != 'windows' && !inputs.test_build
        run: |
          # Determine archive extension based on platform
          case "${{matrix.platform}}" in
            mac|mister|mistex)
              EXT="zip"
              ;;
            *)
              EXT="tar.gz"
              ;;
          esac
          gh release upload "$tag" "_build/${{matrix.platform}}_${{matrix.arch}}/zaparoo-${{matrix.platform}}_${{matrix.arch}}-${VERSION}.${EXT}" --clobber
      - name: Add Batocera package
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ env.BUILD_TAG }}
        if: matrix.platform == 'batocera' && !inputs.test_build
        run: |
          # Map build arch to package arch
          case "${{matrix.arch}}" in
            amd64) PKG_ARCH="x86_64" ;;
            arm64) PKG_ARCH="aarch64" ;;
            arm) PKG_ARCH="armv7l" ;;
          esac
          mkdir -p _build/packages/batocera
          BUILD_ARCH=${{matrix.arch}} PKG_ARCH=${PKG_ARCH} VERSION=${VERSION} task batocera:package-arch
          gh release upload "$tag" "_build/packages/batocera/zaparoo-core-${VERSION}-1-${PKG_ARCH}.pkg.tar.zst" --clobber
      - name: Upload Batocera binary as artifact
        if: matrix.platform == 'batocera'
        uses: actions/upload-artifact@v4
        with:
          name: batocera-binary-${{matrix.arch}}
          path: _build/batocera_${{matrix.arch}}/zaparoo
          retention-days: 30

  build-batocera-any:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    name: Build universal Batocera package (any arch)
    needs: build
    if: ${{ !cancelled() && needs.build.result == 'success' }}
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            scripts/
            cmd/batocera/scripts/
            Taskfile.dist.yml
          sparse-checkout-cone-mode: false
      - name: Write release version
        run: |
          VERSION="${BUILD_TAG#v}"
          # For test builds without a real version tag, use commit hash
          if [[ ! "$VERSION" =~ ^[0-9] ]]; then
            VERSION="$(git rev-parse --short HEAD)-dev"
          fi
          echo "Version: $VERSION"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zstd
      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Download Batocera amd64 binary
        uses: actions/download-artifact@v4
        with:
          name: batocera-binary-amd64
          path: _build/batocera_amd64/
      - name: Download Batocera arm64 binary
        uses: actions/download-artifact@v4
        with:
          name: batocera-binary-arm64
          path: _build/batocera_arm64/
      - name: Download Batocera arm binary
        uses: actions/download-artifact@v4
        with:
          name: batocera-binary-arm
          path: _build/batocera_arm/
      - name: Build universal Batocera package
        run: APP_VERSION=${VERSION} task batocera:package-any-from-artifacts
      - name: Upload Batocera any-arch package to release
        if: ${{ !inputs.test_build }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ env.BUILD_TAG }}
        run: |
          gh release upload "$tag" "_build/packages/batocera/zaparoo-core-${VERSION}-1-any.pkg.tar.zst" --clobber

#  build_mac_app:
#    runs-on: macos-12
#    name: Package and release Mac app
#    needs:
#      - build
#    steps:
#      - uses: actions/checkout@master
#      - name: Download core arm64
#        uses: actions/download-artifact@v3
#        with:
#          name: core-arm64
#          path: FranzCocoa/resources/
#      - name: Download core x86_64
#        uses: actions/download-artifact@v3
#        with:
#          name: core-x86_64
#          path: FranzCocoa/resources/
#      - name: Install Certificates
#        run: |
#          # https://docs.github.com/en/actions/deployment/deploying-xcode-applications/installing-an-apple-certificate-on-macos-runners-for-xcode-development
#          MAC_DEV_CER_PATH=$RUNNER_TEMP/madev.p12
#          DEVELOPER_ID_CER_PATH=$RUNNER_TEMP/devid.p12
#          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
#          echo -n "$MAC_DEV_CER" | base64 --decode -o $MAC_DEV_CER_PATH
#          echo -n "$DEVELOPER_ID_CER" | base64 --decode -o $DEVELOPER_ID_CER_PATH
#          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
#          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
#          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
#          security import $MAC_DEV_CER_PATH -P "$MAC_DEV_CER_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
#          security import $DEVELOPER_ID_CER_PATH -P "$DEVELOPER_ID_CER_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
#          security list-keychain -d user -s $KEYCHAIN_PATH
#        env:
#          DEVELOPER_ID_CER: ${{ secrets.DEVELOPER_ID_CER }}
#          DEVELOPER_ID_CER_PASSWORD: ${{ secrets.DEVELOPER_ID_CER_PASSWORD }}
#          MAC_DEV_CER: ${{ secrets.MAC_DEV_CER }}
#          MAC_DEV_CER_PASSWORD: ${{ secrets.MAC_DEV_CER_PASSWORD }}
#          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
#      - name: Build Franz.app
#        run: |
#          mkdir -p dist
#          npx create-dmg dist/Franz.app dist/
#          mv dist/Franz*.dmg dist/Franz.dmg
#      - name: Notarize Franz.dmg
#        run: |
#          xcrun notarytool submit \
#            --team-id 'H3YE679B58' \
#            --apple-id 'bogdan@defn.io' \
#            --password "$NOTARY_PASSWORD" \
#            --wait \
#            dist/Franz.dmg
#          xcrun stapler staple dist/Franz.dmg
#        env:
#          NOTARY_PASSWORD: ${{ secrets.NOTARY_PASSWORD }}
#      - name: Upload Franz.dmg
#        uses: actions/upload-artifact@v3
#        with:
#          name: Franz.dmg
#          path: dist/Franz.dmg
