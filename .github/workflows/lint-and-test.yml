name: Lint and Test

on:
  pull_request:
  push:
    branches:
      - main
  workflow_call:

# Cancel in-progress runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: read

jobs:
  # Detect what files changed to skip tests on doc-only changes
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            code:
              - 'pkg/**'
              - 'cmd/**'
              - 'go.mod'
              - 'go.sum'
              - '.github/workflows/**'
              - '.golangci.yml'

  lint:
    name: Lint
    needs: changes
    if: needs.changes.outputs.code == 'true' || github.event_name != 'pull_request'
    timeout-minutes: 10
    strategy:
      fail-fast: false # Continue testing on other OS even if one fails
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: false

      - name: Configure Go paths for Windows
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "D:\go-cache" | Out-Null
          New-Item -ItemType Directory -Force -Path "D:\go-mod-cache" | Out-Null
          New-Item -ItemType Directory -Force -Path "D:\go-tmp" | Out-Null
          Add-Content -Path $env:GITHUB_ENV -Value "GOCACHE=D:\go-cache"
          Add-Content -Path $env:GITHUB_ENV -Value "GOMODCACHE=D:\go-mod-cache"
          Add-Content -Path $env:GITHUB_ENV -Value "GOTMPDIR=D:\go-tmp"

      - name: Restore Go cache (Unix)
        if: matrix.os != 'windows-latest'
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: no-match-${{ runner.os }}
          restore-keys: |
            ${{ runner.os }}-go-${{ hashFiles('go.mod') }}-

      - name: Restore Go cache (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/cache/restore@v4
        with:
          path: |
            D:\go-mod-cache
            D:\go-cache
          key: no-match-${{ runner.os }}
          restore-keys: |
            ${{ runner.os }}-go-${{ hashFiles('go.mod') }}-

      - name: Download Go modules
        run: go mod download

      - name: Cache APT packages (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        uses: awalsh128/cache-apt-pkgs-action@v1.6.0
        with:
          packages: libnfc-dev libgtk-3-dev libx11-dev libpcsclite-dev libasound2-dev
          version: 1.1

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: latest
          args: --timeout=5m

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        run: govulncheck ./...

  quick-test:
    name: Quick Test (Unit)
    needs: changes
    if: needs.changes.outputs.code == 'true' || github.event_name != 'pull_request'
    timeout-minutes: 10
    strategy:
      fail-fast: false # Continue testing on other OS even if one fails
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: false

      - name: Configure Go paths for Windows
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "D:\go-cache" | Out-Null
          New-Item -ItemType Directory -Force -Path "D:\go-mod-cache" | Out-Null
          New-Item -ItemType Directory -Force -Path "D:\go-tmp" | Out-Null
          Add-Content -Path $env:GITHUB_ENV -Value "GOCACHE=D:\go-cache"
          Add-Content -Path $env:GITHUB_ENV -Value "GOMODCACHE=D:\go-mod-cache"
          Add-Content -Path $env:GITHUB_ENV -Value "GOTMPDIR=D:\go-tmp"

      - name: Restore Go cache (Unix)
        if: matrix.os != 'windows-latest'
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: no-match-${{ runner.os }}
          restore-keys: |
            ${{ runner.os }}-go-${{ hashFiles('go.mod') }}-

      - name: Restore Go cache (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/cache/restore@v4
        with:
          path: |
            D:\go-mod-cache
            D:\go-cache
          key: no-match-${{ runner.os }}
          restore-keys: |
            ${{ runner.os }}-go-${{ hashFiles('go.mod') }}-

      - name: Download Go modules
        run: go mod download

      - name: Cache APT packages (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        uses: awalsh128/cache-apt-pkgs-action@v1.6.0
        with:
          packages: libnfc-dev libgtk-3-dev libx11-dev libpcsclite-dev libasound2-dev
          version: 1.1

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install libusb pkg-config

      - name: Cache scoop packages (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/cache@v4
        with:
          path: ~\scoop
          key: ${{ runner.os }}-scoop-pkg-config

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          if (-not (Get-Command scoop -ErrorAction SilentlyContinue)) {
            irm get.scoop.sh | iex
          }
          scoop install pkg-config

      - name: Run unit tests (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        env:
          GOMAXPROCS: 2
        run: go test -v -short -race ./...

      - name: Run unit tests (Unix)
        if: matrix.os != 'windows-latest'
        run: go test -v -short -race ./...

  full-test:
    name: Full Test (Unit + Integration)
    needs: changes
    if: needs.changes.outputs.code == 'true' || github.event_name != 'pull_request'
    timeout-minutes: 20
    # Only run on Linux for PRs, all platforms for main/tags
    strategy:
      fail-fast: false
      matrix:
        os: ${{ github.event_name == 'pull_request' && fromJSON('["ubuntu-latest"]') || fromJSON('["ubuntu-latest", "macos-latest", "windows-latest"]') }}
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: false

      - name: Configure Go paths for Windows
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path "D:\go-cache" | Out-Null
          New-Item -ItemType Directory -Force -Path "D:\go-mod-cache" | Out-Null
          New-Item -ItemType Directory -Force -Path "D:\go-tmp" | Out-Null
          Add-Content -Path $env:GITHUB_ENV -Value "GOCACHE=D:\go-cache"
          Add-Content -Path $env:GITHUB_ENV -Value "GOMODCACHE=D:\go-mod-cache"
          Add-Content -Path $env:GITHUB_ENV -Value "GOTMPDIR=D:\go-tmp"

      - name: Restore Go cache (Unix)
        if: matrix.os != 'windows-latest'
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: no-match-${{ runner.os }}
          restore-keys: |
            ${{ runner.os }}-go-${{ hashFiles('go.mod') }}-

      - name: Restore Go cache (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/cache/restore@v4
        with:
          path: |
            D:\go-mod-cache
            D:\go-cache
          key: no-match-${{ runner.os }}
          restore-keys: |
            ${{ runner.os }}-go-${{ hashFiles('go.mod') }}-

      - name: Download Go modules
        run: go mod download

      - name: Cache APT packages (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        uses: awalsh128/cache-apt-pkgs-action@v1.6.0
        with:
          packages: libnfc-dev libgtk-3-dev libx11-dev libpcsclite-dev libasound2-dev
          version: 1.1

      - name: Install dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install libusb pkg-config

      - name: Cache scoop packages (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/cache@v4
        with:
          path: ~\scoop
          key: ${{ runner.os }}-scoop-pkg-config

      - name: Install dependencies (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          if (-not (Get-Command scoop -ErrorAction SilentlyContinue)) {
            irm get.scoop.sh | iex
          }
          scoop install pkg-config

      # Tests include property-based tests (rapid) which run ~100 iterations each.
      # On failure, rapid generates .fail files which are uploaded as artifacts.
      - name: Run full tests (Windows)
        if: matrix.os == 'windows-latest'
        shell: bash
        env:
          GOMAXPROCS: 2
        run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

      - name: Run full tests (Unix)
        if: matrix.os != 'windows-latest'
        run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

      - name: Upload rapid failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: rapid-failures-${{ matrix.os }}
          path: '**/testdata/rapid/**/*.fail'
          if-no-files-found: ignore

      - name: Run deadlock detection tests
        if: matrix.os == 'ubuntu-latest'
        run: go test -tags=deadlock -race -count=1 ./...

      - name: Upload coverage to Codecov
        if: matrix.os == 'ubuntu-latest' # Only upload coverage once
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage.txt
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: true

      - name: Save Go cache (Unix)
        if: github.ref == 'refs/heads/main' && matrix.os != 'windows-latest'
        uses: actions/cache/save@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('go.mod') }}-${{ github.run_id }}

      - name: Save Go cache (Windows)
        if: github.ref == 'refs/heads/main' && matrix.os == 'windows-latest'
        uses: actions/cache/save@v4
        with:
          path: |
            D:\go-mod-cache
            D:\go-cache
          key: ${{ runner.os }}-go-${{ hashFiles('go.mod') }}-${{ github.run_id }}
