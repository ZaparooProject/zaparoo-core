version: "3"

tasks:
  build-metadata:
    internal: true
    cmds:
      - go run scripts/tasks/utils/windowsmeta/main.go -version "${APP_VERSION}"
      - task: :docker:run
        vars:
          IMAGE_NAME: zaparoo/zigcc
          EXEC: sh -c 'cd cmd/windows && go-winres make --arch="amd64,arm64,386"'

  build-installer:
    internal: true
    cmds:
      - go run scripts/tasks/utils/windowsiss/main.go -version "${APP_VERSION}" -arch "{{.BUILD_ARCH}}"
      - cp "cmd/windows/winres/icon.ico" "_build/windows_{{.BUILD_ARCH}}"
      - docker rm -f zaparoo-innosetup 2>/dev/null || true
      - docker container create --name zaparoo-innosetup {{if env "CI"}}--user 0:0{{end}} --entrypoint sh amake/innosetup -c "{{if env "CI"}}chown -R root:root /home/xclient && {{end}}chmod -R 777 /work && iscc setup.iss"
      - docker cp "_build/windows_{{.BUILD_ARCH}}/setup.iss" zaparoo-innosetup:/work/
      - docker cp "_build/windows_{{.BUILD_ARCH}}/Zaparoo.exe" zaparoo-innosetup:/work/
      - docker cp "_build/windows_{{.BUILD_ARCH}}/LICENSE.txt" zaparoo-innosetup:/work/
      - docker cp "_build/windows_{{.BUILD_ARCH}}/README.txt" zaparoo-innosetup:/work/
      - docker cp "_build/windows_{{.BUILD_ARCH}}/icon.ico" zaparoo-innosetup:/work/
      - docker start -i -a zaparoo-innosetup
      - mkdir -p "_build/windows_{{.BUILD_ARCH}}/Output"
      - docker cp zaparoo-innosetup:/work/Output/. "_build/windows_{{.BUILD_ARCH}}/Output"
      - docker rm zaparoo-innosetup
# this docker image has a permissions bug when running on github CI so we're
# we're working around it atm by manually copying everything in and out of the image
#      - >-
#        docker run --rm -i -v "${PWD}:/work"
#        amake/innosetup
#        "_build/windows_{{.BUILD_ARCH}}/setup.iss"

  build-arm64:
    desc: Build Windows ARM64 binary with installer
    cmds:
      - task: :zigcc:setup
      - task: build-metadata
      - task: :zigcc:build-windows-arm64
      - task: build-installer
        vars:
          BUILD_ARCH: arm64

  build-amd64:
    desc: Build Windows AMD64 binary with installer
    cmds:
      - task: :zigcc:setup
      - task: build-metadata
      - task: :zigcc:build-windows-amd64
      - task: build-installer
        vars:
          BUILD_ARCH: amd64

  build-386:
    desc: Build Windows 386 binary with installer
    cmds:
      - task: :zigcc:setup
      - task: build-metadata
      - task: :zigcc:build-windows-386
      - task: build-installer
        vars:
          BUILD_ARCH: "386"

  build-launchbox-plugin:
    desc: Build LaunchBox plugin DLL using Docker
    dir: scripts/windows/launchbox-plugin
    vars:
      OUTPUT_DIR: "{{.ROOT_DIR}}/_build/windows_amd64"
      PLUGIN_FOLDER: "Zaparoo LaunchBox Integration"
    status:
      - test -f "{{.OUTPUT_DIR}}/{{.PLUGIN_FOLDER}}.zip"
    cmds:
      - |
        if [ ! -f "lib/Unbroken.LaunchBox.Plugins.dll" ]; then
          echo "Error: lib/Unbroken.LaunchBox.Plugins.dll not found"
          echo "Copy from LaunchBox installation: LaunchBox/Core/Unbroken.LaunchBox.Plugins.dll"
          exit 1
        fi
      - docker build --target build -t zaparoo-launchbox-plugin "{{.ROOT_DIR}}/scripts/windows/launchbox-plugin"
      - docker create --name zaparoo-launchbox-plugin-temp zaparoo-launchbox-plugin /bin/true
      - mkdir -p "{{.OUTPUT_DIR}}/{{.PLUGIN_FOLDER}}"
      - docker cp zaparoo-launchbox-plugin-temp:/build/ZaparooLaunchBoxPlugin.dll "{{.OUTPUT_DIR}}/{{.PLUGIN_FOLDER}}/"
      - docker rm zaparoo-launchbox-plugin-temp
      - cd "{{.OUTPUT_DIR}}" && zip -r "{{.PLUGIN_FOLDER}}.zip" "{{.PLUGIN_FOLDER}}"
