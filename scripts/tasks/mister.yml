version: "3"

tasks:
  build-arm:
    cmds:
      - task: :cross-build:setup
      - task: :docker:build-app
        vars:
          PLATFORM: mister
          BUILD_ARCH: arm
          IMAGE_NAME: zaparoo/universal-build
          APP_BIN: zaparoo.sh
          CC: "zig cc -target arm-linux-musleabihf"
          CXX: "zig c++ -target arm-linux-musleabihf"
          EXTRA_LDFLAGS: "-linkmode external -extldflags '-static'"
          EXTRA_DOCKER_ARGS: '-e CGO_CFLAGS="-I/opt/libnfc/arm-linux-musleabihf/include -I/opt/deps/arm-linux-musleabihf/include" -e CGO_LDFLAGS="-L/opt/libnfc/arm-linux-musleabihf/lib -L/opt/deps/arm-linux-musleabihf/lib -lnfc -lusb -lusb-1.0"'

  deploy-arm:
    cmds:
      - task: build-arm
      - scp _build/mister_arm/zaparoo.sh root@${MISTER_IP}:/media/fat/Scripts/zaparoo.sh
      - ssh root@${MISTER_IP} /media/fat/Scripts/zaparoo.sh -service restart