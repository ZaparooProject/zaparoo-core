version: "3"

tasks:
  build-arm64:
    cmds:
      - task: :cross-build:setup
      - task: :docker:build-app
        vars:
          PLATFORM: mistex
          BUILD_ARCH: arm64
          IMAGE_NAME: zaparoo/universal-build
          APP_BIN: zaparoo.sh
          CC: "zig cc -target aarch64-linux-musl"
          CXX: "zig c++ -target aarch64-linux-musl"
          EXTRA_LDFLAGS: "-linkmode external -extldflags '-static'"
          EXTRA_DOCKER_ARGS: '-e CGO_CFLAGS="-I/opt/libnfc/aarch64-linux-musl/include -I/opt/deps/aarch64-linux-musl/include" -e CGO_LDFLAGS="-L/opt/libnfc/aarch64-linux-musl/lib -L/opt/deps/aarch64-linux-musl/lib -lnfc -lusb -lusb-1.0"'

  deploy-arm64:
    cmds:
      - task: build-arm64
      - scp _build/mistex_arm64/zaparoo.sh root@${MISTEX_IP}:/media/fat/Scripts/zaparoo.sh
      - ssh root@${MISTEX_IP} /media/fat/Scripts/zaparoo.sh -service restart