version: "3"

tasks:
  build-amd64:
    desc: Build Batocera AMD64 binary
    cmds:
      - task: :zigcc:build-linux-amd64
        vars:
          PLATFORM: batocera

  build-arm64:
    desc: Build Batocera ARM64 binary
    cmds:
      - task: :zigcc:build-linux-arm64
        vars:
          PLATFORM: batocera

  build-arm:
    desc: Build Batocera ARM binary
    cmds:
      - task: :zigcc:build-linux-arm
        vars:
          PLATFORM: batocera

  package:
    desc: Build Batocera pacman packages for all architectures
    deps: [build-amd64, build-arm64, build-arm]
    vars:
      TEMPLATE_DIR: scripts/batocera/template
      BUILD_DIR: _build/packages/batocera
    cmds:
      - rm -rf {{.BUILD_DIR}}
      - mkdir -p {{.BUILD_DIR}}
      - task: package-arch
        vars:
          BUILD_ARCH: amd64
          PKG_ARCH: x86_64
          BUILD_DIR: "{{.BUILD_DIR}}"
          TEMPLATE_DIR: "{{.TEMPLATE_DIR}}"
          VERSION: "{{.APP_VERSION}}"
      - task: package-arch
        vars:
          BUILD_ARCH: arm64
          PKG_ARCH: aarch64
          BUILD_DIR: "{{.BUILD_DIR}}"
          TEMPLATE_DIR: "{{.TEMPLATE_DIR}}"
          VERSION: "{{.APP_VERSION}}"
      - task: package-arch
        vars:
          BUILD_ARCH: arm
          PKG_ARCH: armv7l
          BUILD_DIR: "{{.BUILD_DIR}}"
          TEMPLATE_DIR: "{{.TEMPLATE_DIR}}"
          VERSION: "{{.APP_VERSION}}"
      - echo "Packages created in {{.BUILD_DIR}}:"
      - ls -la {{.BUILD_DIR}}/*.pkg.tar.zst

  package-arch:
    desc: Build Batocera pacman package for specific architecture
    vars:
      BUILD_DIR: '{{.BUILD_DIR | default "_build/packages/batocera"}}'
      TEMPLATE_DIR: '{{.TEMPLATE_DIR | default "scripts/batocera/template"}}'
      # Sanitize version for pacman: replace dashes with underscores (e.g., 2.8.0-beta1 -> 2.8.0_beta1)
      PKG_VERSION: '{{.VERSION | replace "-" "_"}}'
      PACKAGE_NAME: zaparoo-core-{{.PKG_VERSION}}-1-{{.PKG_ARCH}}
      PACKAGE_DIR: "{{.BUILD_DIR}}/{{.PACKAGE_NAME}}"
    cmds:
      - echo "Creating package for {{.PKG_ARCH}}..."
      - rm -rf {{.PACKAGE_DIR}}
      - mkdir -p {{.PACKAGE_DIR}}/userdata/system/services
      - cp -r {{.TEMPLATE_DIR}}/. {{.PACKAGE_DIR}}/
      - mkdir -p {{.PACKAGE_DIR}}/userdata/roms/ports
      - cp cmd/batocera/scripts/ports/Zaparoo.sh {{.PACKAGE_DIR}}/userdata/roms/ports/Zaparoo.sh
      - cp _build/batocera_{{.BUILD_ARCH}}/zaparoo {{.PACKAGE_DIR}}/userdata/system/
      - cp cmd/batocera/scripts/zaparoo_write_game.sh {{.PACKAGE_DIR}}/userdata/system/
      - sed -i "s/__VERSION__/{{.PKG_VERSION}}/g" {{.PACKAGE_DIR}}/.PKGINFO
      - sed -i "s/__ARCH__/{{.PKG_ARCH}}/g" {{.PACKAGE_DIR}}/.PKGINFO
      - chmod +x {{.PACKAGE_DIR}}/userdata/system/zaparoo
      - chmod +x {{.PACKAGE_DIR}}/userdata/system/zaparoo_write_game.sh
      - chmod +x {{.PACKAGE_DIR}}/userdata/system/services/zaparoo_service
      - chmod +x {{.PACKAGE_DIR}}/userdata/roms/ports/Zaparoo.sh
      - task: create-package
        vars:
          PACKAGE_DIR: "{{.PACKAGE_DIR}}"
          PACKAGE_NAME: "{{.PACKAGE_NAME}}"
          BUILD_DIR: "{{.BUILD_DIR}}"

  create-package:
    internal: true
    dir: "{{.PACKAGE_DIR}}"
    cmds:
      - echo "Creating package manually..."
      # Copy BATOEXEC files to userdata/system/pacman/batoexec/ for pacman hooks
      - mkdir -p userdata/system/pacman/batoexec
      - |
        i=0
        for f in .BATOEXEC*; do
          if [ -f "$f" ]; then
            cp "$f" "userdata/system/pacman/batoexec/zaparoo-core_$i"
            echo "Copied $f -> userdata/system/pacman/batoexec/zaparoo-core_$i"
            i=$((i+1))
          fi
        done
      - tar -cf - .PKGINFO .BATOEXEC* userdata | zstd -c --rsyncable - -o "../{{.PACKAGE_NAME}}.pkg.tar.zst"
      - chmod go+r "../{{.PACKAGE_NAME}}.pkg.tar.zst"

  package-any:
    desc: Build universal Batocera pacman package for all architectures
    deps: [build-amd64, build-arm64, build-arm]
    vars:
      TEMPLATE_DIR: scripts/batocera/template
      BUILD_DIR: _build/packages/batocera
      # Sanitize version for pacman: replace dashes with underscores (e.g., 2.8.0-beta1 -> 2.8.0_beta1)
      PKG_VERSION: '{{.APP_VERSION | replace "-" "_"}}'
      PACKAGE_NAME: zaparoo-core-{{.PKG_VERSION}}-1-any
      PACKAGE_DIR: "{{.BUILD_DIR}}/{{.PACKAGE_NAME}}"
    cmds:
      - echo "Creating universal 'any' architecture package..."
      - rm -f {{.BUILD_DIR}}/{{.PACKAGE_NAME}}.pkg.tar.zst
      - rm -rf {{.PACKAGE_DIR}}
      - mkdir -p {{.PACKAGE_DIR}}/userdata/system/services
      - cp -r {{.TEMPLATE_DIR}}/. {{.PACKAGE_DIR}}/
      - mkdir -p {{.PACKAGE_DIR}}/userdata/roms/ports
      - cp cmd/batocera/scripts/ports/Zaparoo.sh {{.PACKAGE_DIR}}/userdata/roms/ports/Zaparoo.sh
      - cp cmd/batocera/scripts/zaparoo_wrapper.sh {{.PACKAGE_DIR}}/userdata/system/zaparoo
      - cp cmd/batocera/scripts/zaparoo_write_game.sh {{.PACKAGE_DIR}}/userdata/system/
      - cp _build/batocera_amd64/zaparoo {{.PACKAGE_DIR}}/userdata/system/zaparoo-x86_64
      - cp _build/batocera_arm64/zaparoo {{.PACKAGE_DIR}}/userdata/system/zaparoo-aarch64
      - cp _build/batocera_arm/zaparoo {{.PACKAGE_DIR}}/userdata/system/zaparoo-armv7l
      - sed -i "s/__VERSION__/{{.PKG_VERSION}}/g" {{.PACKAGE_DIR}}/.PKGINFO
      - sed -i "s/__ARCH__/any/g" {{.PACKAGE_DIR}}/.PKGINFO
      - chmod +x {{.PACKAGE_DIR}}/userdata/system/zaparoo
      - chmod +x {{.PACKAGE_DIR}}/userdata/system/zaparoo_write_game.sh
      - chmod +x {{.PACKAGE_DIR}}/userdata/system/zaparoo-x86_64
      - chmod +x {{.PACKAGE_DIR}}/userdata/system/zaparoo-aarch64
      - chmod +x {{.PACKAGE_DIR}}/userdata/system/zaparoo-armv7l
      - chmod +x {{.PACKAGE_DIR}}/userdata/system/services/zaparoo_service
      - chmod +x {{.PACKAGE_DIR}}/userdata/roms/ports/Zaparoo.sh
      - task: create-package
        vars:
          PACKAGE_DIR: "{{.PACKAGE_DIR}}"
          PACKAGE_NAME: "{{.PACKAGE_NAME}}"
          BUILD_DIR: "{{.BUILD_DIR}}"
      - echo "Universal package created at {{.BUILD_DIR}}/{{.PACKAGE_NAME}}.pkg.tar.zst"

  package-any-from-artifacts:
    desc: Build universal Batocera package from pre-built binaries (for CI)
    preconditions:
      - test -f _build/batocera_amd64/zaparoo
      - test -f _build/batocera_arm64/zaparoo
      - test -f _build/batocera_arm/zaparoo
    vars:
      TEMPLATE_DIR: scripts/batocera/template
      BUILD_DIR: _build/packages/batocera
      # Sanitize version for pacman: replace dashes with underscores (e.g., 2.8.0-beta1 -> 2.8.0_beta1)
      PKG_VERSION: '{{.APP_VERSION | replace "-" "_"}}'
      PACKAGE_NAME: zaparoo-core-{{.PKG_VERSION}}-1-any
      PACKAGE_DIR: "{{.BUILD_DIR}}/{{.PACKAGE_NAME}}"
    cmds:
      - echo "Creating universal 'any' architecture package from artifacts..."
      - rm -f {{.BUILD_DIR}}/{{.PACKAGE_NAME}}.pkg.tar.zst
      - rm -rf {{.PACKAGE_DIR}}
      - mkdir -p {{.PACKAGE_DIR}}/userdata/system/services
      - cp -r {{.TEMPLATE_DIR}}/. {{.PACKAGE_DIR}}/
      - mkdir -p {{.PACKAGE_DIR}}/userdata/roms/ports
      - cp cmd/batocera/scripts/ports/Zaparoo.sh {{.PACKAGE_DIR}}/userdata/roms/ports/Zaparoo.sh
      - cp cmd/batocera/scripts/zaparoo_wrapper.sh {{.PACKAGE_DIR}}/userdata/system/zaparoo
      - cp cmd/batocera/scripts/zaparoo_write_game.sh {{.PACKAGE_DIR}}/userdata/system/
      - cp _build/batocera_amd64/zaparoo {{.PACKAGE_DIR}}/userdata/system/zaparoo-x86_64
      - cp _build/batocera_arm64/zaparoo {{.PACKAGE_DIR}}/userdata/system/zaparoo-aarch64
      - cp _build/batocera_arm/zaparoo {{.PACKAGE_DIR}}/userdata/system/zaparoo-armv7l
      - sed -i "s/__VERSION__/{{.PKG_VERSION}}/g" {{.PACKAGE_DIR}}/.PKGINFO
      - sed -i "s/__ARCH__/any/g" {{.PACKAGE_DIR}}/.PKGINFO
      - chmod +x {{.PACKAGE_DIR}}/userdata/system/zaparoo
      - chmod +x {{.PACKAGE_DIR}}/userdata/system/zaparoo_write_game.sh
      - chmod +x {{.PACKAGE_DIR}}/userdata/system/zaparoo-x86_64
      - chmod +x {{.PACKAGE_DIR}}/userdata/system/zaparoo-aarch64
      - chmod +x {{.PACKAGE_DIR}}/userdata/system/zaparoo-armv7l
      - chmod +x {{.PACKAGE_DIR}}/userdata/system/services/zaparoo_service
      - chmod +x {{.PACKAGE_DIR}}/userdata/roms/ports/Zaparoo.sh
      - task: create-package
        vars:
          PACKAGE_DIR: "{{.PACKAGE_DIR}}"
          PACKAGE_NAME: "{{.PACKAGE_NAME}}"
          BUILD_DIR: "{{.BUILD_DIR}}"
      - echo "Universal package created at {{.BUILD_DIR}}/{{.PACKAGE_NAME}}.pkg.tar.zst"

  deploy:
    desc: "Build and deploy binary directly to Batocera system"
    vars:
      ARCH: "{{if .CLI_ARGS}}{{.CLI_ARGS}}{{else}}amd64{{end}}"
      BATOCERA_HOST: '{{.BATOCERA_HOST | default "root@${BATOCERA_IP}"}}'
    cmds:
      - task: build-{{.ARCH}}
      - echo "Stopping zaparoo service..."
      - ssh {{.BATOCERA_HOST}} "batocera-services stop zaparoo_service || true"
      - echo "Copying binary..."
      - scp _build/batocera_{{.ARCH}}/zaparoo {{.BATOCERA_HOST}}:/userdata/system/zaparoo
      - ssh {{.BATOCERA_HOST}} "chmod +x /userdata/system/zaparoo"
      - echo "Starting zaparoo service..."
      - ssh {{.BATOCERA_HOST}} "batocera-services start zaparoo_service"
      - echo "Deploy complete!"

  deploy-package:
    desc: Build universal package and deploy to Batocera system
    vars:
      BATOCERA_HOST: '{{.BATOCERA_HOST | default "root@${BATOCERA_IP}"}}'
      # Sanitize version for pacman: replace dashes with underscores (e.g., 2.8.0-beta1 -> 2.8.0_beta1)
      PKG_VERSION: '{{.APP_VERSION | replace "-" "_"}}'
    cmds:
      - task: package-any
      - scp _build/packages/batocera/zaparoo-core-{{.PKG_VERSION}}-1-any.pkg.tar.zst {{.BATOCERA_HOST}}:/tmp/
      - ssh {{.BATOCERA_HOST}} "pacman -R --noconfirm zaparoo-core || true"
      - ssh {{.BATOCERA_HOST}} "pacman -U --noconfirm /tmp/zaparoo-core-{{.PKG_VERSION}}-1-any.pkg.tar.zst"
