version: "3"

tasks:
  build-amd64:
    desc: Build Linux AMD64 binary
    cmds:
      - task: :zigcc:build-linux-amd64

  build-arm64:
    desc: Build Linux ARM64 binary
    cmds:
      - task: :zigcc:build-linux-arm64

  build-arm:
    desc: Build Linux ARM binary
    cmds:
      - task: :zigcc:build-linux-arm

  build-appimage-amd64:
    desc: Build Zaparoo AppImage for x86_64
    cmds:
      - task: build-amd64
      - task: build-appimage-arch
        vars:
          BUILD_ARCH: amd64
          APPIMAGE_ARCH: x86_64

  build-appimage-arm64:
    desc: Build Zaparoo AppImage for aarch64
    cmds:
      - task: build-arm64
      - task: build-appimage-arch
        vars:
          BUILD_ARCH: arm64
          APPIMAGE_ARCH: aarch64

  build-appimage-arm:
    desc: Build Zaparoo AppImage for armhf
    cmds:
      - task: build-arm
      - task: build-appimage-arch
        vars:
          BUILD_ARCH: arm
          APPIMAGE_ARCH: armhf

  build-appimage-arch:
    internal: true
    vars:
      TEMPLATE_DIR: scripts/linux/template
      APPDIR: "_build/AppDir-{{.BUILD_ARCH}}"
      BINARY_PATH: "_build/linux_{{.BUILD_ARCH}}/zaparoo"
      OUTPUT_DIR: "_build"
      VERSION: "{{.APP_VERSION}}"
      APPIMAGE_NAME: "zaparoo-{{.APPIMAGE_ARCH}}-{{.VERSION}}.AppImage"
      APPIMAGETOOL: "appimagetool-{{.APPIMAGE_ARCH}}.AppImage"
      APPIMAGETOOL_URL: "https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-{{.APPIMAGE_ARCH}}.AppImage"
      UPDATE_INFO: "gh-releases-zsync|ZaparooProject|zaparoo-core|latest|zaparoo-{{.APPIMAGE_ARCH}}-*.AppImage.zsync"
    cmds:
      - echo "Building AppImage for {{.APPIMAGE_ARCH}}..."
      - test -f {{.BINARY_PATH}} || (echo "Binary not found at {{.BINARY_PATH}}" && exit 1)
      - rm -rf {{.APPDIR}}
      - mkdir -p {{.APPDIR}}/usr/bin
      - mkdir -p {{.APPDIR}}/usr/share/applications
      - mkdir -p {{.APPDIR}}/usr/share/icons/hicolor/16x16/apps
      - mkdir -p {{.APPDIR}}/usr/share/icons/hicolor/32x32/apps
      - mkdir -p {{.APPDIR}}/usr/share/icons/hicolor/48x48/apps
      - mkdir -p {{.APPDIR}}/usr/share/icons/hicolor/128x128/apps
      - mkdir -p {{.APPDIR}}/usr/share/icons/hicolor/256x256/apps
      - mkdir -p {{.APPDIR}}/usr/share/metainfo
      - cp {{.BINARY_PATH}} {{.APPDIR}}/usr/bin/zaparoo
      - chmod +x {{.APPDIR}}/usr/bin/zaparoo
      - cp pkg/platforms/linux/installer/zaparoo.desktop {{.APPDIR}}/usr/share/applications/zaparoo.desktop
      - cp pkg/platforms/linux/installer/icons/hicolor/16x16/apps/zaparoo.png {{.APPDIR}}/usr/share/icons/hicolor/16x16/apps/zaparoo.png
      - cp pkg/platforms/linux/installer/icons/hicolor/32x32/apps/zaparoo.png {{.APPDIR}}/usr/share/icons/hicolor/32x32/apps/zaparoo.png
      - cp pkg/platforms/linux/installer/icons/hicolor/48x48/apps/zaparoo.png {{.APPDIR}}/usr/share/icons/hicolor/48x48/apps/zaparoo.png
      - cp pkg/platforms/linux/installer/icons/hicolor/128x128/apps/zaparoo.png {{.APPDIR}}/usr/share/icons/hicolor/128x128/apps/zaparoo.png
      - cp pkg/platforms/linux/installer/icons/hicolor/256x256/apps/zaparoo.png {{.APPDIR}}/usr/share/icons/hicolor/256x256/apps/zaparoo.png
      - cp pkg/platforms/linux/installer/icons/hicolor/256x256/apps/zaparoo.png {{.APPDIR}}/zaparoo.png
      - cp {{.TEMPLATE_DIR}}/AppRun {{.APPDIR}}/AppRun
      - chmod +x {{.APPDIR}}/AppRun
      - cp {{.APPDIR}}/usr/share/applications/zaparoo.desktop {{.APPDIR}}/zaparoo.desktop
      - cp {{.TEMPLATE_DIR}}/zaparoo.appdata.xml {{.APPDIR}}/usr/share/metainfo/zaparoo.appdata.xml
      - |
        if [ ! -f "{{.OUTPUT_DIR}}/{{.APPIMAGETOOL}}" ]; then
          echo "Downloading appimagetool for {{.APPIMAGE_ARCH}}..."
          wget -q "{{.APPIMAGETOOL_URL}}" -O "{{.OUTPUT_DIR}}/{{.APPIMAGETOOL}}"
          chmod +x "{{.OUTPUT_DIR}}/{{.APPIMAGETOOL}}"
        fi
      - cd {{.OUTPUT_DIR}} && ARCH={{.APPIMAGE_ARCH}} VERSION={{.VERSION}} ./{{.APPIMAGETOOL}} --no-appstream --updateinformation "{{.UPDATE_INFO}}" AppDir-{{.BUILD_ARCH}} {{.APPIMAGE_NAME}} 2>&1 | grep -v "AppImages require" || true
      - test -f {{.OUTPUT_DIR}}/{{.APPIMAGE_NAME}} || (echo "AppImage build failed" && exit 1)
      - echo "AppImage built at {{.OUTPUT_DIR}}/{{.APPIMAGE_NAME}}"